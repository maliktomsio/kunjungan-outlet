<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sales Visit System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- XLSX EXPORT -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,Arial;
    background:#f4f6f9;
}
.hidden{display:none}

header{
    background:linear-gradient(135deg,#0f172a,#1e40af);
    color:#fff;
    padding:25px;
    text-align:center;
    border-radius:0 0 25px 25px;
}

.card{
    background:#fff;
    margin:15px;
    padding:18px;
    border-radius:18px;
    box-shadow:0 10px 25px rgba(0,0,0,.06);
}

input,select,button{
    width:100%;
    padding:12px;
    border-radius:12px;
    margin-top:8px;
    border:1px solid #ddd;
    font-size:15px;
}

button{
    background:#2563eb;
    color:#fff;
    border:none;
}

.btn-red{background:#dc2626}
.btn-green{background:#059669}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:13px;
}

th,td{
    padding:8px;
    border-bottom:1px solid #eee;
}

th{
    background:#f1f5f9;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="card">
    <h2>üîê Login Sales</h2>
    <input id="salesInput" placeholder="Nama Sales">
    <button onclick="login()">Masuk</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
    <h2>üìç SALES VISIT</h2>
    <div id="salesName"></div>
</header>

<div class="card">
    <input type="date" id="tanggal">

    <select id="outlet">
        <option value="">Pilih Outlet</option>
        <option>A088 ‚Äì AMELIA BAKEKO</option>
        <option>A095 ‚Äì AMOR KIOS</option>
        <option>A120 ‚Äì AGORA TIMUR NUSANTARA</option>
        <option>A124 ‚Äì AZIZAH KIOS</option>
        <option>A129 ‚Äì APRI KIOS SEBRANG</option>
        <option>D029 ‚Äì DILA KIOS</option>
        <option>D044 ‚Äì DILLA KIOS PASIR PANJANG</option>
        <option>E004 ‚Äì EMMI TAN BU</option>
        <option>H040 ‚Äì HENDRO KOLAM AIR BESAR</option>
        <option>I042 ‚Äì IBU HASNI NASKUN</option>
        <option>J012 ‚Äì JOKO MAS</option>
        <option>K018 ‚Äì KODAR MAS</option>
        <option>K055 ‚Äì KIOS IRMA</option>
        <option>M085 ‚Äì MAULANA KIOS</option>
        <option>N003 ‚Äì NANDO</option>
        <option>P032 ‚Äì PUTRA SOLO</option>
        <option>R038 ‚Äì RS MISI SEBRANG</option>
        <option>S050 ‚Äì SUMBER REJEKI PASIR PANJANG</option>
        <option>S076 ‚Äì SINAR MERAPI</option>
        <option>S091 ‚Äì SINAR MUDA KIOS (EBA)</option>
        <option>S092 ‚Äì KANTIN SMAN 2 (SLAMET)</option>
        <option>S111 ‚Äì SABYAN KIOS</option>
        <option>S160 ‚Äì SIMPANG TIGA KIOS</option>
        <option>T002 ‚Äì ANTO KIOS</option>
        <option>Y014 ‚Äì YULI BAKEKO</option>
        <option>F002 ‚Äì FADJRIN</option>
        <option>R024 ‚Äì ROMAIKA KIOS</option>
        <option>S037 ‚Äì SOKIMIN SEBRANG</option>
        <option>D010 ‚Äì DICKY SEBRANG</option>
        <option>A111 ‚Äì ALKA KIOS</option>
        <option>B064 ‚Äì BEACHES CAFE</option>
    </select>

    <button class="btn-green" onclick="checkIn()">üü¢ CHECK-IN</button>
    <button class="btn-red" onclick="checkOut()">üî¥ CHECK-OUT</button>
</div>

<div class="card">
    <button onclick="exportExcel()">‚¨á Export Excel (.xlsx)</button>

    <table id="table">
        <tr>
            <th>Tanggal</th>
            <th>Outlet</th>
            <th>Check-In</th>
            <th>Check-Out</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Sales</th>
        </tr>
    </table>
</div>

</div>

<script>
let visits = JSON.parse(localStorage.getItem("visits")) || [];
let currentVisit = null;

// AUTO LOGIN
const savedSales = localStorage.getItem("salesName");
if(savedSales){
    loginBox.style.display = "none";
    app.classList.remove("hidden");
    salesName.innerText = "Sales: " + savedSales;
}

function login(){
    const name = document.getElementById("salesInput").value.trim();
    if(!name) return alert("Masukkan nama sales");

    localStorage.setItem("salesName", name);
    location.reload();
}

function checkIn(){
    if(!tanggal.value || !outlet.value){
        alert("Isi tanggal dan outlet");
        return;
    }

    navigator.geolocation.getCurrentPosition(pos=>{
        currentVisit = {
            tanggal: tanggal.value,
            outlet: outlet.value,
            checkin: new Date().toLocaleTimeString(),
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
        };
        alert("Check-in berhasil");
    },()=>{
        alert("GPS tidak aktif");
    });
}

function checkOut(){
    if(!currentVisit){
        alert("Belum check-in");
        return;
    }

    currentVisit.checkout = new Date().toLocaleTimeString();
    currentVisit.sales = localStorage.getItem("salesName");

    visits.push(currentVisit);
    localStorage.setItem("visits", JSON.stringify(visits));
    currentVisit = null;

    render();
    alert("Kunjungan tersimpan");
}

function render(){
    let html = `
    <tr>
        <th>Tanggal</th>
        <th>Outlet</th>
        <th>Check-In</th>
        <th>Check-Out</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Sales</th>
    </tr>`;

    visits.forEach(v=>{
        html += `
        <tr>
            <td>${v.tanggal}</td>
            <td>${v.outlet}</td>
            <td>${v.checkin}</td>
            <td>${v.checkout}</td>
            <td>${v.lat.toFixed(5)}</td>
            <td>${v.lng.toFixed(5)}</td>
            <td>${v.sales}</td>
        </tr>`;
    });

    document.getElementById("table").innerHTML = html;
}

function exportExcel(){
    const ws = XLSX.utils.json_to_sheet(visits);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Kunjungan Sales");
    XLSX.writeFile(wb, "laporan-kunjungan-sales.xlsx");
}

render();
</script>

</body>
</html>
